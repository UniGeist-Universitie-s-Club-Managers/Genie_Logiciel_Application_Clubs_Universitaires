{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Tableau de bord administrateur{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .dashboard-header {
        margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
        color: #417690;
        font-size: 28px;
        margin-bottom: 10px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
        margin: 0 0 15px 0;
        color: #417690;
        font-size: 18px;
        font-weight: 600;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
        margin-top: 5px;
    }
    
    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .stat-row:last-child {
        border-bottom: none;
    }
    
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }
    
    .chart-container {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container h2 {
        margin: 0 0 20px 0;
        color: #417690;
        font-size: 20px;
        font-weight: 600;
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    
    .top-clubs-list {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .top-clubs-list h2 {
        margin: 0 0 20px 0;
        color: #417690;
        font-size: 20px;
        font-weight: 600;
    }
    
    .club-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .club-item:last-child {
        margin-bottom: 0;
    }
    
    .club-name {
        font-weight: 500;
        color: #333;
    }
    
    .club-activity {
        color: #417690;
        font-weight: 600;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Tableau de bord administrateur</h1>
        <p>Vue d'ensemble des statistiques et activit√©s du syst√®me</p>
    </div>

    <!-- Cartes de statistiques -->
    <div class="stats-grid">
        <!-- Ressources -->
        <div class="stat-card">
            <h3>üìö Ressources</h3>
            <div class="stat-row">
                <span class="stat-label">Cette semaine</span>
                <span class="stat-value">{{ resources_this_week }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Ce mois</span>
                <span class="stat-value">{{ resources_this_month }}</span>
            </div>
        </div>

        <!-- Aides -->
        <div class="stat-card">
            <h3>ü§ù Aides</h3>
            <div class="stat-row">
                <span class="stat-label">Cette semaine</span>
                <span class="stat-value">{{ aids_this_week }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Ce mois</span>
                <span class="stat-value">{{ aids_this_month }}</span>
            </div>
        </div>

        <!-- Demandes d'aide -->
        <div class="stat-card">
            <h3>üìã Demandes d'aide</h3>
            <div class="stat-row">
                <span class="stat-label">En attente</span>
                <span class="stat-value" style="color: #f0ad4e;">{{ aid_requests_pending }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Approuv√©es</span>
                <span class="stat-value" style="color: #5cb85c;">{{ aid_requests_approved }}</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Rejet√©es</span>
                <span class="stat-value" style="color: #d9534f;">{{ aid_requests_rejected }}</span>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="charts-section">
        <!-- Graphique : Ressources et Aides par mois -->
        <div class="chart-container">
            <h2>Activit√© mensuelle (6 derniers mois)</h2>
            <div class="chart-wrapper">
                <canvas id="monthlyActivityChart"></canvas>
            </div>
        </div>

        <!-- Graphique : Top 5 Clubs -->
        <div class="chart-container">
            <h2>Top 5 des clubs les plus actifs</h2>
            <div class="chart-wrapper">
                <canvas id="topClubsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Liste des clubs les plus actifs -->
    <div class="top-clubs-list">
        <h2>D√©tails des clubs les plus actifs</h2>
        {% if top_clubs %}
            {% for club in top_clubs %}
            <div class="club-item">
                <span class="club-name">{{ club.name }}</span>
                <span class="club-activity">
                    {{ club.total_activities }} activit√©{{ club.total_activities|pluralize }}
                    ({{ club.total_resources }} ressource{{ club.total_resources|pluralize }}, 
                     {{ club.total_aids }} aide{{ club.total_aids|pluralize }})
                </span>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>Aucun club avec des activit√©s pour le moment.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Chargement de Chart.js via CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Graphique : Activit√© mensuelle (Ressources et Aides)
    const monthlyCtx = document.getElementById('monthlyActivityChart').getContext('2d');
    
    // Pr√©parer les donn√©es pour le graphique mensuel
    const monthsLabels = [
        {% for month in months_data %}
        "{{ month|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const resourcesData = [
        {% for count in resources_by_month %}
        {{ count }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const aidsData = [
        {% for count in aids_by_month %}
        {{ count }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: monthsLabels,
            datasets: [
                {
                    label: 'Ressources',
                    data: resourcesData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Aides',
                    data: aidsData,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: false
                }
            }
        }
    });

    // Graphique : Top 5 Clubs
    const clubsCtx = document.getElementById('topClubsChart').getContext('2d');
    
    // Pr√©parer les donn√©es pour le graphique des clubs
    const clubsLabels = [
        {% for club in top_clubs %}
        "{{ club.name|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const clubsData = [
        {% for club in top_clubs %}
        {{ club.total_activities }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const topClubsChart = new Chart(clubsCtx, {
        type: 'bar',
        data: {
            labels: clubsLabels,
            datasets: [{
                label: 'Nombre total d\'activit√©s',
                data: clubsData,
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // Graphique horizontal
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
</script>
{% endblock %}
