{% extends "base.html" %}
{% load static %}

{% block title %}Threads - MonForum{% endblock %}

{% block extra_css %}
<style>
/* Styles pour la page des threads */

.hover-bg-light:hover {
  background-color: rgba(0,0,0,0.03);
  transition: background-color 0.2s;
}

.list-group-item {
  cursor: pointer;
  border: none;
  padding: 15px 20px;
}

.list-group-item .text-dark {
  color: #212529 !important;
}

.card {
  background: rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.3);
}

.card-body {
  padding: 0;
}

h1.h3 {
  color: #f8f9fa;
}

.text-muted {
  color: rgba(255,255,255,0.6) !important;
}

.btn-primary, .btn-outline-secondary, .btn-outline-danger {
  border-radius: 8px;
}

.btn-primary i, .btn-outline-secondary i, .btn-outline-danger i {
  vertical-align: middle;
}

.text-decoration-none {
  text-decoration: none !important;
}

.text-decoration-none:hover {
  text-decoration: underline !important;
}

.badge {
  font-size: 0.8rem;
  padding: 0.35em 0.65em;
}

.pagination .page-link {
  color: #f8f9fa;
  background-color: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
}

.pagination .page-link:hover {
  background-color: rgba(13,110,253,0.25);
  color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">
    <i class="fas fa-comments me-2 text-primary"></i>Discussions
  </h1>
  {% if user.is_authenticated %}
    <a href="{% url 'forum:thread-create' %}" class="btn btn-primary">
      <i class="fas fa-plus me-2"></i>Nouvelle discussion
    </a>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    {% if threads %}
      <div class="list-group list-group-flush">
        {% for thread in threads %}
          <div class="list-group-item d-flex justify-content-between align-items-start hover-bg-light">
            <div class="ms-2 me-auto w-100">
              <div class="d-flex align-items-center mb-1 justify-content-between">
                <div class="me-3">
                  <h5 class="mb-0">
                    <a href="{% url 'forum:thread-detail' thread.pk %}" 
                       class="text-decoration-none text-dark fw-bold">
                      {{ thread.title }}
                    </a>
                  </h5>
                  {% if thread.is_pinned %}
                    <span class="badge bg-warning text-dark ms-2">
                      <i class="fas fa-thumbtack me-1"></i>Épinglé
                    </span>
                  {% endif %}
                </div>
                <div class="text-muted small d-none d-md-block">
                  <div>
                    <i class="fas fa-user me-1"></i>
                    {{ thread.author.get_full_name|default:thread.author.username }}
                  </div>
                </div>
              </div>

              <div class="d-flex align-items-center text-muted small">
                <div class="me-3 d-md-none">
                  <i class="fas fa-user me-1"></i>
                  {{ thread.author.get_full_name|default:thread.author.username }}
                </div>
                <div class="me-3">
                  <i class="far fa-clock me-1"></i>
                  {{ thread.created_at|date:"d M Y H:i" }}
                </div>
                <div>
                  <i class="fas fa-comment me-1"></i>
                  {{ thread.posts.count }} réponse{{ thread.posts.count|pluralize }}
                </div>
              </div>
            </div>
            
            <div class="d-flex align-items-center gap-2 ms-3">
              <span class="badge bg-primary rounded-pill px-3 py-2">
                {{ thread.posts.count }}
              </span>
              
              {% if thread.can_edit_for_user %}
                <a href="{% url 'forum:thread-update' thread.pk %}" 
                   class="btn btn-sm btn-outline-secondary" 
                   data-bs-toggle="tooltip" 
                   title="Modifier"
                   onclick="event.stopPropagation();">
                  <i class="fas fa-edit"></i>
                </a>
              {% endif %}
              
              {% if thread.can_delete_for_user %}
                <a href="{% url 'forum:thread-delete' thread.pk %}" 
                   class="btn btn-sm btn-outline-danger" 
                   data-bs-toggle="tooltip" 
                   title="Supprimer"
                   onclick="event.stopPropagation();">
                  <i class="fas fa-trash"></i>
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="fas fa-comment-slash fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">Aucune discussion pour l'instant</h4>
        <p class="text-muted">Soyez le premier à lancer une discussion !</p>
        {% if user.is_authenticated %}
          <a href="{% url 'forum:thread-create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Créer une discussion
          </a>
        {% else %}
          <a href="{% url 'login' %}?next={% url 'forum:thread-list' %}" class="btn btn-primary">
            <i class="fas fa-sign-in-alt me-2"></i>Se connecter pour participer
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

{% if is_paginated %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1" aria-label="Première">
            <span aria-hidden="true">&laquo;&laquo;</span>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Précédent">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Suivant">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Dernière">
            <span aria-hidden="true">&raquo;&raquo;</span>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialisation des tooltips Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (el) {
    try {
      new bootstrap.Tooltip(el);
    } catch (e) {
      console.warn('tooltip init failed', e);
    }
  });

  // Empêche la propagation du clic sur les boutons d'action
  var actionButtons = document.querySelectorAll('.list-group-item .btn');
  actionButtons.forEach(function (btn) {
    btn.addEventListener('click', function (ev) {
      ev.stopPropagation();
    });
  });
});
</script>
{% endblock %}
